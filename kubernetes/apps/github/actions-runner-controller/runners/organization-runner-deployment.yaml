---
# https://github.com/actions-runner-controller/actions-runner-controller
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: ${SECRET_GH_ORGANIZATION}-runner
spec:
  # replicas: 1
  template:
    spec:
      organization: ${SECRET_GH_ORGANIZATION}
      githubAPICredentialsFrom:
        secretRef:
          name: ${SECRET_GH_ORGANIZATION}-runner
      labels:
        - ${SETTING_CLUSTERNAME}
        - home-infra
      dockerMTU: 1400
      env: []

---
# https://github.com/actions-runner-controller/actions-runner-controller#autoscaling
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: ${SECRET_GH_ORGANIZATION}-runner
spec:
  scaleTargetRef:
    name: ${SECRET_GH_ORGANIZATION}-runner
  githubAPICredentialsFrom:
    secretRef:
      name: ${SECRET_GH_ORGANIZATION}-runner
    # Uncomment the below in case the target is not RunnerDeployment but RunnerSet
    # kind: RunnerSet
  scaleDownDelaySecondsAfterScaleOut: 300
  minReplicas: 1
  maxReplicas: 5
  metrics:
    - type: PercentageRunnersBusy
      scaleUpThreshold: "0.75" # The percentage of busy runners at which the number of desired runners are re-evaluated to scale up
      scaleDownThreshold: "0.3" # The percentage of busy runners at which the number of desired runners are re-evaluated to scale down
      scaleUpAdjustment: 2 # The scale up runner count added to desired count
      scaleDownAdjustment: 1 # The scale down runner count subtracted from the desired count
