---
version: "3"

tasks:
  setup:
    - task: config
    - task: kubeconfig

  init:
    desc: Initialize talos configuration
    dir: infra/talos
    cmds:
      # https://github.com/budimanjojo/talhelper
      - "talhelper gensecret > talsecret.sops.yaml"
      - "sops -e -i talsecret.sops.yaml"

  config:
    desc: Let talhelper generate the configuration files
    dir: infra/talos
    cmds:
      - "talhelper genconfig"

  install:talos01:
    desc: Install talos01
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.51 \
          --file clusterconfig/talos-flux-talos01.yaml

  install:talos02:
    desc: Install talos02
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.52 \
          --file clusterconfig/talos-flux-talos02.yaml

  install:talos04:
    desc: Install talos04
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.54 \
          --file clusterconfig/talos-flux-talos04.yaml

  install:talos05:
    desc: Install talos05
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.55 \
          --file clusterconfig/talos-flux-talos05.yaml

  install:talos06:
    desc: Install talos06
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.56 \
          --file clusterconfig/talos-flux-talos06.yaml

  install:talos07:
    desc: Install talos07
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config --insecure \
          --nodes 192.168.1.57 \
          --file clusterconfig/talos-flux-talos07.yaml

  update:talos01:
    desc: Update talos01
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.51 \
          --file clusterconfig/talos-flux-talos01.yaml

  update:talos02:
    desc: Update talos02
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.52 \
          --file clusterconfig/talos-flux-talos02.yaml

  update:talos03:
    desc: Update talos03
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.53 \
          --file clusterconfig/talos-flux-talos03.yaml

  update:talos04:
    desc: Update talos04
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.54 \
          --file clusterconfig/talos-flux-talos04.yaml

  update:talos05:
    desc: Update talos05
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.55 \
          --file clusterconfig/talos-flux-talos05.yaml

  update:talos06:
    desc: Update talos06
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.56 \
          --file clusterconfig/talos-flux-talos06.yaml

  update:talos07:
    desc: Update talos07
    dir: infra/talos
    cmds:
      - |
        talosctl apply-config \
          --nodes 192.168.1.57 \
          --file clusterconfig/talos-flux-talos07.yaml

  bootstrap:
    desc: Bootstrap talos etcd on 1st node
    dir: infra/talos
    cmds:
      - |
        talosctl bootstrap \
          --talosconfig=clusterconfig/talosconfig \
          --nodes 192.168.1.51

  kubeconfig:
    desc: write kube config
    dir: infra/talos
    cmds:
      - |
        talosctl kubeconfig \
          --talosconfig=clusterconfig/talosconfig \
          --nodes 192.168.1.50 \
          --endpoints 192.168.1.50 \
          --force
